#remotes::install_github("qpetitjean/MoveR")
library(MoveR)

# Import data from corrected data generated by AnimalTA tracking software ---- 
datamvr <- MoveR::readAnimalTA("./Name_corr_data/rpi1_10fps_R06_Corrected.csv", rawDat = FALSE)

tst <- read.csv("./Name_corr_data/rpi1_10fps_R06_Corrected.csv")
tst <- read.delim("./Name_corr_data/rpi1_10fps_R06_Corrected.csv",sep=";")

orig_data <- read.csv("./Corr_coord_data/rpi1_10fps_R06_Corrected.csv", sep=";")
str(orig_data)
str(datamvr)
str(tst)

#datamvr2 <- MoveR::readAnimalTA("./Test_trajectoire_larves_HC/Arena_0Ind0.csv")
names(datamvr)
MoveR::getInfo(datamvr)# supp info given extracted by the function depending of the tracking software used 

# Add information about video 
trackdat <- MoveR::setInfo(datamvr, frameR = MoveR::getInfo(datamvr)
                           $frameR, scale = 1/37, imgRes = c(1080, 720))
str(trackdat)
MoveR::getInfo(trackdat)
# quickplot of tracking data ---- 
MoveR::drawTracklets(trackdat)

#quickplot of selected individual 
MoveR::drawTracklets(
  trackdat,
  selTrack = c(905033,805041)
)

mtext(
  substitute(paste(bold("A"))),
  side = 3,
  line = 0,
  adj = 0,
  padj = -0.5
)

# Transformation in list by individual name ---- 
trackdatList <- MoveR::convert2List(trackdat)
unique(trackdatList[["identity"]])
trackdatList[["identity"]] <- paste("Ag.larvae", trackdatList[["identity"]], sep = "_")
trackdat <- MoveR::convert2Tracklets(trackdatList, by = "identity")

# graph par ID 
# MoveR::drawTracklets(
#   trackdat,
#   colId = "identity",
#   selTrack = c("Ag.larvae_805041")
# )

# Filter NA values ----- 

filter.InfX <-
  MoveR::filterFunc(
    trackdat,
    toFilter = "x.pos",
    customFunc = function(x)
      is.na(x)
  ) 

filter.InfY <-
  MoveR::filterFunc(
    trackdat,
    toFilter = "y.pos",
    customFunc = function(x)
      is.na(x)
  )

filter.Inf <-
  MoveR::mergeFilters(filters = list(filter.InfX, filter.InfY),
                      cond = TRUE)

trackDat.Infilt <-
  MoveR::filterTracklets(trackdat,
                         filter = filter.Inf,
                         splitCond = TRUE,
                         minDur = MoveR::getInfo(trackdat, "frameR"))

# display the summary of the filtering process
str(trackDat.Infilt[[1]])

# plot after correction, color based on individual identity 
MoveR::drawTracklets(
  trackDat.Infilt[[1]],
  colId = "identity",
  #selTrack = c(2:5)
)

# Filter on individual size ---- 

# the upper and lower limits to filter on particles length, according to the scale (expressed in cm)
LengthLim <- c(0.015, 0.1)

# convert the previously filtered data into a list to ease particle's size conversion (from pixels to cm)
trackDat.InfiltList <-  MoveR::convert2List(trackDat.Infilt[[2]])

# Use analyseTracklets function to scale the length of the particles (maj.ax) in cm by iterating over the tracklets
trackDat2 <- MoveR::analyseTracklets(trackDat.Infilt[[2]],
                                     customFunc =
                                       list(indLengthcm = function(x) x[["maj.ax"]] * MoveR::getInfo(trackDat.Infilt[[2]], "scale")))

# plot the distribution of particles' length (log10) and the size limits
par(mfrow=c(1,2))
hist(log10(MoveR::convert2List(trackDat2)[["indLengthcm"]]),
     breaks = 50,
     main = paste0("Particles' length (log10) and \ntreshold (cm)= ", LengthLim[1], "; ", LengthLim[2]),
     xlab = "Particles' length (log10)",
     cex.main = 0.8)
abline(v = log10(LengthLim), col = "firebrick")
mtext(substitute(paste(bold("A"))), side = 3, line = 0, adj = 0, padj = -0.5)

# create the filter
filter.length <-
  MoveR::filterFunc(
    trackDat2,
    toFilter = "indLengthcm",
    customFunc = function(x)
      x < LengthLim[1] | x > LengthLim[2]
  )

# apply the filter on the data using the frame rate as minimum duration of the tracklets
trackDat.lenfilt <-
  MoveR::filterTracklets(trackDat2,
                         filter.length,
                         splitCond = TRUE,
                         minDur = MoveR::getInfo(trackDat2, "frameR"))

# plot the distribution of particles' length (log10) after the filtering
hist(log10(MoveR::convert2List(trackDat.lenfilt[[2]])$maj.ax),
     breaks = 50,
     main = "Particles' length (log10) \nafter filtering",
     xlab = "Particles' length (log10)",
     cex.main = 0.8)
mtext(substitute(paste(bold("B"))), side = 3, line = 0, adj = 0, padj = -0.5)

# Filter based on speed ---- 
# retrieve the previously filtered data and used them to compute particles' speed
trackDat3 <- trackDat.Infilt[[2]]
str(trackDat3[[1]])
# Use analyseTracklets function to compute the speed of the particles by iterating over the tracklets
# here we use the "speed()" modulus to compute the speed over each tracklet
trackDat3 <-
  MoveR::analyseTracklets(trackDat3,
                          customFunc = list(
                            speed = function(x)
                              MoveR::speed(
                                x,
                                timeCol = "frame",
                                scale = 1
                              )
                          ))

# retrieve the speed of all particles in a vector
particleSpeed <- MoveR::convert2List(trackDat3)[["speed"]]

# compute the 999th percentile of particles' speed (log10 transformed data)
quant999th <- quantile(log10(particleSpeed), c(0.999), na.rm = T)

# plot the particles' speed (log10) distribution and the 999th percentile before filtering
par(mfrow=c(1,2))
hist(log10(particleSpeed), breaks = 100, main = "particles' speed (log10) and 999th quantile \nbefore filtering",
     cex.main= 0.9,
     xlab = "Particles' speed (log10)")
abline(v = quant999th, col = "#660000")
mtext(substitute(paste(bold("A"))), side = 3, line = 0, adj = 0, padj = -0.5)

# the result seem satisfactory since with this threshold we will remove only the few moments where particles speed overpass 22.5 pixels per frame while we conserve the bimodal distribution of the particles' speed.
# hence, create the filter based on the computed 999th quantile 
filter.speed <-
  MoveR::filterFunc(
    trackDat3,
    toFilter = "speed",
    customFunc = function(x)
      x < 0 | x > 10 ^ quant999th
  )

# apply the filter on the data using the frame rate as minimum duration of the tracklets
trackDat.speedfilt <-
  MoveR::filterTracklets(trackDat3,
                         filter.speed,
                         splitCond = TRUE,
                         minDur = MoveR::getInfo(trackDat3, "frameR"))

# plot particles' speed (log10) distribution after the filtering
hist(log10(MoveR::convert2List(trackDat.speedfilt[[2]])[["speed"]]),
     breaks = 100,
     main = "Particles' speed (log10) \nafter filtering",
     cex.main= 0.9,
     xlab = "Particles' speed (log10)")
mtext(substitute(paste(bold("B"))), side = 3, line = 0, adj = 0, padj = -0.5)

# summary of filtering by speed 

str(trackDat.speedfilt[[1]])
